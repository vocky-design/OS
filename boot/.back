	mov eax,KERNEL_START_SECTOR
	mov ebx,KERNEL_BIN_BASE_ADDR
	mov cl,200
	call rd_disk_m_32

;----------------------------------------------------------
;--------------------开启分页机制------------------------------
;----------------------------------------------------------
;1.创建必要的PDE和PTE
	call setup_page
	;准备好段访问的虚拟地址
	sgdt [gdt_ptr]
	mov ebx,[gdt_ptr+2]
	or dword [ebx+8*3+4],0xc0000000		;将显存段映射到内核地址
	add dword [ebx],0xc0000000			;将gdt基址映射到内核地址
	add esp,0xc0000000					;将栈指针映射到内核地址
;2.把页目录表地址赋值给cr3
	mov eax,PAGE_DIR_TABLE_POS
	mov cr3,eax
;3.打开cr0的pg位(第31位)
	mov eax,cr0
	or eax,0x80000000
	mov cr0,eax

;在开启分页后，用gdt新的地址重新加载
	lgdt [gdt_ptr]
	jmp dword SELECTOR_CODE:enter_kernel		;作用:1.清空流水线2.更新段描述符缓冲寄存器
enter_kernel:

	call kernel_init
	mov esp,0xc009f000							;最高可用地址9fbff的4kb对齐	
;----------------------------------------------------------
;--------------------启动内核------------------------------
;----------------------------------------------------------
	jmp KERNEL_ENTRY_POINT
